// scripts/migrate-fe-partition.js
/* eslint-disable no-console */
require('dotenv').config();
const { Client } = require('pg');

function ymKey(d) {
  const y = d.getUTCFullYear();
  const m = String(d.getUTCMonth() + 1).padStart(2, '0');
  return `${y}_${m}`; // seguro p/ identificador
}
function monthBounds(d) {
  const y = d.getUTCFullYear();
  const m = d.getUTCMonth();
  const start = new Date(Date.UTC(y, m, 1)).toISOString().slice(0,10);     // YYYY-MM-DD
  const end   = new Date(Date.UTC(y, m+1, 1)).toISOString().slice(0,10);   // YYYY-MM-DD
  return { start, end };
}

async function ensurePartition(client, parent, key, start, end) {
  const part = `funnel_events_${key}`;                 // ex: funnel_events_2025_10
  const full = `public.${part}`;
  const { rows } = await client.query(`SELECT to_regclass($1) AS r`, [full]);
  if (!rows[0].r) {
    // cria partição
    await client.query(
      `CREATE TABLE ${full} PARTITION OF ${parent}
       FOR VALUES FROM (DATE '${start}') TO (DATE '${end}')`
    );
    // índice UNIQUE local (dedupe por event_id)
    await client.query(
      `CREATE UNIQUE INDEX IF NOT EXISTS ux_fe_event_id_${key}
       ON ${full} (event_id)`
    );
  }
}

async function run() {
  const cn = process.env.DATABASE_URL;
  if (!cn) { console.error('[PART] DATABASE_URL não definido'); process.exit(2); }

  const client = new Client({ connectionString: cn, ssl: { rejectUnauthorized: false } });
  await client.connect();

  try {
    console.log('[PART] start');
    await client.query('BEGIN');
    await client.query(`SET LOCAL lock_timeout = '5s'`);
    await client.query(`SET LOCAL statement_timeout = '300s'`);

    // Já é particionada?
    const { rows: partRows } = await client.query(`
      SELECT 1
      FROM pg_partitioned_table pt
      JOIN pg_class c ON c.oid = pt.partrelid
      JOIN pg_namespace n ON n.oid = c.relnamespace
      WHERE n.nspname='public' AND c.relname='funnel_events'
      LIMIT 1;
    `);
    const isPartitioned = partRows.length > 0;

    if (!isPartitioned) {
      console.log('[PART] funnel_events não é particionada: criando tabela nova + migrando');

      // 1) Parent particionado (sem PK no parent)
      await client.query(`
        CREATE TABLE IF NOT EXISTS public.funnel_events_new (
          id BIGINT GENERATED BY DEFAULT AS IDENTITY,
          bot_id BIGINT NULL,
          bot_slug TEXT NULL,
          event_name TEXT NOT NULL,
          event_id TEXT NOT NULL,
          tg_id BIGINT NULL,
          transaction_id TEXT NULL,
          payload_id TEXT NULL,
          price_cents INTEGER NULL,
          meta JSONB NULL,
          occurred_at TIMESTAMPTZ NOT NULL DEFAULT now(),
          created_at TIMESTAMPTZ NOT NULL DEFAULT now()
        ) PARTITION BY RANGE (occurred_at);
      `);

      // 2) Indexes "partitioned" no parent (o PG cria children nas partições)
      await client.query(`
        CREATE INDEX IF NOT EXISTS ix_funnel_events_bot_time
          ON public.funnel_events_new (bot_id, occurred_at DESC);
      `);
      await client.query(`
        CREATE INDEX IF NOT EXISTS ix_funnel_events_bot_tg
          ON public.funnel_events_new (bot_id, tg_id);
      `);

      // 3) Partições prev/now/next
      const now = new Date();
      const months = [
        new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth() - 1, 1)),
        new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), 1)),
        new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth() + 1, 1)),
      ];
      for (const d of months) {
        const { start, end } = monthBounds(d);
        const key = ymKey(d);
        await ensurePartition(client, 'public.funnel_events_new', key, start, end);
      }

      // 4) Partição default (captura ranges inesperados)
      const defExists = await client.query(`SELECT to_regclass('public.funnel_events_default') AS r`);
      if (!defExists.rows[0].r) {
        await client.query(`
          CREATE TABLE public.funnel_events_default
          PARTITION OF public.funnel_events_new DEFAULT
        `);
        await client.query(`
          CREATE UNIQUE INDEX IF NOT EXISTS ux_fe_event_id_default
          ON public.funnel_events_default (event_id)
        `);
      }

      // 5) Copia dados da antiga (se existir)
      const old = await client.query(`SELECT to_regclass('public.funnel_events') AS r`);
      if (old.rows[0].r) {
        console.log('[PART] copiando dados de funnel_events -> funnel_events_new');
        await client.query(`
          INSERT INTO public.funnel_events_new
          (id, bot_id, bot_slug, event_name, event_id, tg_id, transaction_id, payload_id, price_cents, meta, occurred_at, created_at)
          SELECT id, bot_id, bot_slug, event_name, event_id, tg_id, transaction_id, payload_id, price_cents, meta, occurred_at, created_at
          FROM public.funnel_events
          ON CONFLICT DO NOTHING;
        `);
        // Renomeia antiga para _legacy
        await client.query(`ALTER TABLE public.funnel_events RENAME TO funnel_events_legacy;`);
      }

      // 6) Swap: funnel_events_new -> funnel_events
      await client.query(`ALTER TABLE public.funnel_events_new RENAME TO funnel_events;`);
      console.log('[PART] swap concluído');
    } else {
      console.log('[PART] já particionada: garantindo partições e índices');
      // Garante prev/now/next + default para a já-particionada
      const now = new Date();
      const months = [
        new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth() - 1, 1)),
        new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth(), 1)),
        new Date(Date.UTC(now.getUTCFullYear(), now.getUTCMonth() + 1, 1)),
      ];
      for (const d of months) {
        const { start, end } = monthBounds(d);
        const key = ymKey(d);
        await ensurePartition(client, 'public.funnel_events', key, start, end);
      }
      const defExists = await client.query(`SELECT to_regclass('public.funnel_events_default') AS r`);
      if (!defExists.rows[0].r) {
        await client.query(`
          CREATE TABLE public.funnel_events_default
          PARTITION OF public.funnel_events DEFAULT
        `);
        await client.query(`
          CREATE UNIQUE INDEX IF NOT EXISTS ux_fe_event_id_default
          ON public.funnel_events_default (event_id)
        `);
      }
    }

    await client.query('COMMIT');
    console.log('[PART] done');
    process.exit(0);
  } catch (err) {
    try { await client.query('ROLLBACK'); } catch {}
    console.error('[PART] error:', err && err.stack || err);
    process.exit(1);
  } finally {
    try { await client.end(); } catch {}
  }
}

run();
