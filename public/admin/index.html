<!DOCTYPE html>
<html lang="pt-BR" class="h-full">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Admin ‚Ä¢ Bots</title>
    <link rel="icon" href="data:," />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        darkMode: 'class',
        theme: {
          extend: {
            colors: {
              surface: '#111111',
              surfaceLight: '#1a1a1a',
              surfaceMuted: '#262626',
              accent: '#38bdf8',
            },
            boxShadow: {
              raised: '0 20px 25px -15px rgba(0,0,0,0.65)',
            },
          },
        },
      };
    </script>
    <link rel="stylesheet" href="./admin.css" />
    <script src="/env.js"></script>
  </head>
  <body class="bg-surface text-zinc-100 min-h-full font-sans">
    <div id="app" class="min-h-screen pb-24">
      <header class="sticky top-0 z-30 backdrop-blur bg-surface/90 border-b border-surfaceMuted">
        <div class="mx-auto max-w-6xl px-6 py-4 flex items-center justify-between gap-4">
          <div>
            <h1 class="text-xl font-semibold tracking-wide">Admin ‚Ä¢ Bots</h1>
            <p class="text-sm text-zinc-400" id="public-base-info"></p>
          </div>
          <div class="flex items-center gap-3">
            <button id="admin-token-btn" class="btn-secondary" type="button">
              üîê Chave Admin
            </button>
            <button id="new-bot-btn" class="btn-primary" type="button">
              ‚ûï Novo Bot
            </button>
          </div>
        </div>
      </header>

      <main class="mx-auto max-w-6xl px-6 py-6 space-y-6">
        <div id="bots-list-view" class="space-y-6">
          <section class="rounded-3xl bg-surfaceLight border border-surfaceMuted shadow-raised p-6 space-y-4">
            <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
              <div class="flex-1">
                <label for="search-input" class="sr-only">Buscar bot</label>
                <div class="relative">
                  <span class="pointer-events-none absolute inset-y-0 left-3 flex items-center text-zinc-500">üîé</span>
                  <input
                    id="search-input"
                    type="search"
                    autocomplete="off"
                    placeholder="Buscar por nome/slug‚Ä¶"
                    class="w-full rounded-2xl bg-surface border border-surfaceMuted pl-10 pr-4 py-2 text-sm focus:border-accent focus:ring-2 focus:ring-accent/40 outline-none transition"
                  />
                </div>
              </div>
              <div class="flex gap-3">
                <button id="refresh-btn" class="btn-secondary" type="button">üîÑ Atualizar</button>
              </div>
            </div>

            <div class="overflow-hidden rounded-3xl border border-surfaceMuted">
              <table class="min-w-full divide-y divide-surfaceMuted text-sm" aria-live="polite">
                <thead class="bg-surface">
                  <tr>
                    <th scope="col" class="table-head">Nome</th>
                    <th scope="col" class="table-head">Slug</th>
                    <th scope="col" class="table-head">Provider</th>
                    <th scope="col" class="table-head">Sandbox</th>
                    <th scope="col" class="table-head">Rate/min</th>
                    <th scope="col" class="table-head">Flags</th>
                    <th scope="col" class="table-head">A√ß√µes</th>
                  </tr>
                </thead>
                <tbody id="bots-table-body" class="divide-y divide-surfaceMuted">
                  <!-- Conte√∫do din√¢mico -->
                </tbody>
              </table>
              <div id="empty-state" class="hidden px-6 py-12 text-center text-sm text-zinc-400">
                <p class="font-medium text-zinc-200">Nenhum bot encontrado.</p>
                <p class="mt-2">Clique em ‚ÄúNovo Bot‚Äù para criar.</p>
              </div>
            </div>
            <div id="error-hint" class="hidden rounded-2xl border border-amber-500/50 bg-amber-500/10 px-4 py-3 text-sm text-amber-200"></div>
          </section>

          <section id="instructions-card" class="hidden rounded-3xl border border-surfaceMuted bg-surfaceLight shadow-raised p-6 space-y-4">
            <div class="flex items-start justify-between gap-4">
              <div>
                <h2 class="text-lg font-semibold">Webhook configurado</h2>
                <p class="text-sm text-zinc-400">Use a URL abaixo para configurar o webhook do Telegram. O secret √© definido no backend.</p>
              </div>
              <button id="close-instructions" type="button" class="text-zinc-500 hover:text-zinc-300" aria-label="Fechar instru√ß√µes">‚úñÔ∏è</button>
            </div>
            <div class="rounded-2xl border border-surfaceMuted bg-surface px-4 py-3 flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
              <code id="webhook-url" class="text-sm break-all text-accent"></code>
              <button id="copy-webhook" class="btn-secondary md:self-start" type="button">üìã Copiar URL</button>
            </div>
          </section>
        </div>

        <section id="bot-detail-view" style="display:none" class="space-y-6"></section>

        <template id="tpl-bot-detail">
          <div class="rounded-3xl bg-surfaceLight border border-surfaceMuted shadow-raised p-6 space-y-6">
            <div class="flex flex-col gap-3 md:flex-row md:items-center md:justify-between">
              <h2 class="text-xl font-semibold">Bot ‚Ä¢ <span data-field="name"></span></h2>
              <a class="btn-secondary inline-flex items-center gap-2 px-4 py-2" href="/admin" data-action="back">‚Üê Voltar</a>
            </div>
            <div class="grid gap-4 md:grid-cols-2">
              <div class="form-field">
                <label class="form-label">Nome</label>
                <input data-field="name" type="text" readonly class="form-input" />
              </div>
              <div class="form-field">
                <label class="form-label">Slug</label>
                <input data-field="slug" type="text" readonly class="form-input" />
              </div>
            </div>
            <div class="grid gap-4 md:grid-cols-2">
              <div class="form-field">
                <label class="form-label">Provider</label>
                <input data-field="provider" type="text" readonly class="form-input" />
              </div>
              <div class="form-field">
                <label class="form-label">Renderizador</label>
                <input value="MarkdownV2" type="text" readonly class="form-input" />
              </div>
            </div>
            <div class="grid gap-4 md:grid-cols-2">
              <div class="form-field">
                <label class="form-label">Token do Bot</label>
                <div class="flex items-center gap-2">
                  <input data-field="token" type="password" placeholder="Cole o token aqui" autocomplete="off" class="form-input flex-1" />
                  <button class="btn-secondary text-xs px-3 py-2" data-action="reveal">üëÅ</button>
                  <button class="btn-secondary text-xs px-3 py-2" data-action="save-token">Salvar</button>
                  <button class="btn-primary text-xs px-3 py-2" data-action="validate">Validar</button>
                </div>
                <p class="text-xs text-zinc-400" data-field="token-status"></p>
                <p class="text-xs text-zinc-500" data-field="token-info"></p>
              </div>
              <div class="form-field">
                <label class="form-label">Webhook</label>
                <div class="flex items-center gap-2">
                  <input data-field="webhook" type="text" readonly class="form-input flex-1" />
                  <button class="btn-secondary text-xs px-3 py-2" data-action="copy-webhook">Copiar</button>
                </div>
              </div>
            </div>
            <div class="grid gap-4 md:grid-cols-2">
              <div class="form-field">
                <label class="form-label">Status do Token</label>
                <div class="flex items-center gap-2">
                  <span data-field="has-token-badge" class="text-sm"></span>
                  <span data-field="token-updated-at" class="text-xs text-zinc-500"></span>
                </div>
              </div>
              <div class="form-field">
                <label class="form-label">Envio de Teste</label>
                <div class="space-y-2">
                  <input data-field="test-chat-id" type="text" placeholder="Chat ID (ex: 123456789)" class="form-input text-sm" />
                  <textarea data-field="test-text" placeholder="Texto da mensagem" rows="3" class="form-input text-sm">Teste de envio ‚úÖ</textarea>
                  <button class="btn-primary text-xs px-3 py-2" data-action="send-test">Enviar teste</button>
                  <p class="text-xs text-zinc-400" data-field="send-test-status"></p>
                </div>
              </div>
            </div>
            <p class="text-sm text-zinc-400">
              Padr√µes: <b>MarkdownV2</b>, <b>delay 0</b>, <b>sem watermark</b>, produ√ß√£o (rate <b>60 rpm</b>).
            </p>
            
            <!-- Se√ß√£o Webhook -->
            <div class="border-t border-zinc-700 pt-4 mt-4">
              <h3 class="text-lg font-semibold mb-3">Gerenciar Webhook</h3>
              <div class="space-y-3">
                <div class="form-field">
                  <label class="form-label">URL do Webhook (destino)</label>
                  <input data-field="webhook-url-display" type="text" readonly class="form-input text-sm" />
                  <p class="text-xs text-zinc-500 mt-1">‚ö†Ô∏è Se o ngrok reiniciar e a URL mudar, refa√ßa "Definir Webhook"</p>
                </div>
                <div class="flex gap-2 flex-wrap">
                  <button class="btn-primary text-xs px-4 py-2" data-action="webhook-set">Definir Webhook</button>
                  <button class="btn-secondary text-xs px-4 py-2" data-action="webhook-delete">Remover Webhook</button>
                  <button class="btn-secondary text-xs px-4 py-2" data-action="webhook-status">Ver Status</button>
                </div>
                <div class="rounded-lg bg-zinc-800 p-3" data-field="webhook-status-display" style="display:none;">
                  <p class="text-xs text-zinc-300" data-field="webhook-status-text"></p>
                </div>
              </div>
            </div>
            
            <!-- Se√ß√£o Mensagem Inicial -->
            <div class="border-t border-zinc-700 pt-4 mt-4">
              <h3 class="text-lg font-semibold mb-3">Mensagem Inicial</h3>
              <p class="text-sm text-zinc-400 mb-3">Configure a mensagem que ser√° enviada quando o usu√°rio enviar /start</p>
              <button class="btn-primary text-xs px-4 py-2" data-action="configure-start-message" data-field="configure-start-message-btn">‚úé Configurar mensagem inicial</button>
            </div>
            
            <!-- Se√ß√£o Downsells -->
            <div class="border-t border-zinc-700 pt-4 mt-4">
              <h3 class="text-lg font-semibold mb-3">Downsells</h3>
              <p class="text-sm text-zinc-400 mb-3">Mensagens autom√°ticas enviadas ap√≥s /start ou PIX gerado (apenas se houver PIX n√£o pago)</p>
              <button class="btn-primary text-xs px-4 py-2" data-action="manage-downsells">‚ö° Gerenciar downsells</button>
            </div>
            
            <div class="border-t border-zinc-700 pt-4 mt-4">
              <button class="btn-secondary text-xs px-4 py-2 text-red-400 hover:text-red-300" data-action="delete-bot">üóëÔ∏è Excluir Bot</button>
              <p class="text-xs text-zinc-500 mt-2">Soft delete: o bot ser√° desativado mas os dados permanecer√£o no banco.</p>
            </div>
          </div>
        </template>
      </main>
    </div>

    <div id="toast-container" class="fixed top-4 right-4 z-50 flex flex-col gap-3"></div>

    <div id="modal-overlay" class="modal-overlay hidden" aria-hidden="true"></div>

    <div id="token-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="token-modal-title">
      <div class="modal-content">
        <header class="modal-header">
          <h2 id="token-modal-title" class="text-lg font-semibold">Chave Admin</h2>
          <button class="modal-close" type="button" data-close-modal="token-modal" aria-label="Fechar">‚úñÔ∏è</button>
        </header>
        <form id="token-form" class="space-y-4">
          <div class="space-y-2">
            <label for="token-input" class="text-sm font-medium">Admin API Token</label>
            <div class="relative">
              <input
                id="token-input"
                type="password"
                autocomplete="off"
                class="w-full rounded-2xl bg-surface border border-surfaceMuted px-4 py-2 text-sm focus:border-accent focus:ring-2 focus:ring-accent/40 outline-none transition"
              />
              <button type="button" id="toggle-token-visibility" class="absolute inset-y-0 right-3 flex items-center text-xs text-zinc-400 hover:text-zinc-200">
                Mostrar
              </button>
            </div>
            <p id="token-source" class="text-xs text-zinc-500"></p>
          </div>
          <div class="flex flex-col gap-3 sm:flex-row sm:justify-end">
            <button type="button" id="clear-token" class="btn-secondary sm:flex-1">Limpar</button>
            <button type="submit" class="btn-primary sm:flex-1">Salvar</button>
          </div>
        </form>
      </div>
    </div>

    <div id="bot-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="bot-modal-title">
      <div class="modal-content max-w-2xl">
        <header class="modal-header">
          <h2 id="bot-modal-title" class="text-lg font-semibold">Novo Bot</h2>
          <button class="modal-close" type="button" data-close-modal="bot-modal" aria-label="Fechar">‚úñÔ∏è</button>
        </header>
        <form id="bot-form" class="space-y-5">
          <div class="grid gap-4 md:grid-cols-2">
            <div class="form-field">
              <label for="bot-name" class="form-label">Nome<span class="text-rose-400">*</span></label>
              <input id="bot-name" name="name" type="text" required minlength="2" maxlength="64" class="form-input" />
              <p class="form-hint hidden" data-error-for="name"></p>
            </div>
            <div class="form-field">
              <label for="bot-slug" class="form-label">Slug<span class="text-rose-400">*</span></label>
              <input
                id="bot-slug"
                name="slug"
                type="text"
                required
                pattern="^[a-z0-9][a-z0-9-_]{1,31}$"
                class="form-input"
              />
              <p class="text-xs text-zinc-500">min√∫sculas, n√∫meros, h√≠fen/underscore</p>
              <p class="form-hint hidden" data-error-for="slug"></p>
            </div>
            <div class="form-field">
              <label for="bot-provider" class="form-label">Provider</label>
              <select id="bot-provider" name="provider" class="form-input">
                <option value="pushinpay">pushinpay</option>
                <option value="syncpay">syncpay</option>
                <option value="manual">manual</option>
              </select>
              <p class="form-hint hidden" data-error-for="provider"></p>
            </div>
            <div class="form-field">
              <label for="bot-token" class="form-label">Token do bot</label>
              <div class="flex items-center gap-2">
                <input
                  id="bot-token"
                  name="token"
                  type="password"
                  placeholder="123456:ABC-DEF..."
                  autocomplete="off"
                  class="form-input flex-1"
                />
                <button id="btn-validate-token" type="button" class="btn-secondary whitespace-nowrap">
                  Validar
                </button>
              </div>
              <p class="text-xs text-zinc-500">Nunca compartilhe o token. Ele ser√° usado apenas para autenticar o bot.</p>
              <p id="token-status" class="text-xs text-zinc-400"></p>
            </div>
            <div class="form-field md:col-span-2">
              <label class="form-label inline-flex items-center gap-2">
                <input id="bot-album" name="use_album" type="checkbox" class="form-checkbox" checked />
                Use √°lbum (m√≠dia)
              </label>
              <p class="form-hint hidden" data-error-for="use_album"></p>
            </div>
          </div>
          <p id="defaults-hint" style="margin-top:12px;font-size:12px;opacity:.8">
            <strong>Padr√µes:</strong> MarkdownV2, delay 0, sem watermark, produ√ß√£o (rate 60 rpm).
          </p>
          <div class="flex flex-col gap-3 sm:flex-row sm:justify-end">
            <button type="button" class="btn-secondary sm:flex-1" data-close-modal="bot-modal">Fechar</button>
            <button type="submit" id="create-bot-btn" class="btn-primary sm:flex-1">Criar Bot</button>
          </div>
        </form>
      </div>
    </div>

    <div id="delete-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="delete-modal-title">
      <div class="modal-content">
        <header class="modal-header">
          <h2 id="delete-modal-title" class="text-lg font-semibold">Confirmar Exclus√£o</h2>
          <button class="modal-close" type="button" data-close-modal="delete-modal" aria-label="Fechar">‚úñÔ∏è</button>
        </header>
        <div class="space-y-4">
          <p class="text-sm text-zinc-300">Voc√™ est√° prestes a excluir o bot <strong data-field="delete-bot-name"></strong> (<code data-field="delete-bot-slug"></code>).</p>
          <p class="text-sm text-zinc-400">Esta √© uma opera√ß√£o de <strong>soft delete</strong>. O bot ser√° desativado e n√£o aparecer√° mais na lista, mas os dados permanecer√£o no banco de dados.</p>
          <div class="form-field">
            <label class="inline-flex items-center gap-2 text-sm">
              <input id="delete-confirm-checkbox" type="checkbox" class="form-checkbox" />
              <span>Entendo que o bot ser√° desativado e removido da lista</span>
            </label>
          </div>
          <div class="flex flex-col gap-3 sm:flex-row sm:justify-end">
            <button type="button" class="btn-secondary sm:flex-1" data-close-modal="delete-modal">Cancelar</button>
            <button type="button" id="confirm-delete-btn" class="btn-primary sm:flex-1 bg-red-600 hover:bg-red-700" disabled>Excluir Bot</button>
          </div>
        </div>
      </div>
    </div>

    <div id="start-message-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="start-message-modal-title">
      <div class="modal-content" style="max-width: 600px;">
        <header class="modal-header">
          <h2 id="start-message-modal-title" class="text-lg font-semibold">Mensagem inicial do /start</h2>
          <button class="modal-close" type="button" data-close-modal="start-message-modal" aria-label="Fechar">‚úñÔ∏è</button>
        </header>
        <form id="start-message-form" class="space-y-4">
          <!-- Toggle Ativar -->
          <div class="form-field">
            <label class="inline-flex items-center gap-2 text-sm">
              <input id="start-message-active" type="checkbox" class="form-checkbox" />
              <span class="font-medium">Ativar mensagem personalizada</span>
            </label>
            <p class="text-xs text-zinc-500 mt-1">Quando desativado, usa a mensagem padr√£o do sistema</p>
          </div>

          <!-- Textarea -->
          <div class="form-field" id="start-message-text-field">
            <label for="start-message-text" class="form-label">Texto da mensagem (MarkdownV2)</label>
            <textarea
              id="start-message-text"
              rows="6"
              maxlength="4096"
              placeholder="Ol√°! Bem-vindo ao bot..."
              class="form-input font-mono text-sm resize-y"
              style="min-height: 150px;"
            ></textarea>
            <div class="flex items-center justify-between mt-1">
              <p class="text-xs text-zinc-500">
                <span id="start-message-char-count">0</span> / 4096 caracteres
              </p>
              <p class="text-xs text-zinc-500" id="start-message-updated-at"></p>
            </div>
          </div>

          <!-- Op√ß√µes -->
          <div class="space-y-2" id="start-message-options">
            <div class="form-field">
              <label class="inline-flex items-center gap-2 text-sm">
                <input id="start-message-disable-preview" type="checkbox" class="form-checkbox" />
                <span>Desativar preview de links</span>
              </label>
            </div>
            <div class="form-field">
              <label class="inline-flex items-center gap-2 text-sm">
                <input id="start-message-raw" type="checkbox" class="form-checkbox" />
                <span>Texto j√° vem escapado (raw)</span>
              </label>
              <p class="text-xs text-yellow-500 mt-1 hidden" id="start-message-raw-warning">
                ‚ö†Ô∏è Quando marcado, o MarkdownV2 n√£o ser√° escapado automaticamente
              </p>
            </div>
          </div>

          <!-- Teste r√°pido -->
          <div class="border-t border-zinc-700 pt-4" id="start-message-test-section">
            <h3 class="text-sm font-semibold mb-2">Teste r√°pido</h3>
            <div class="flex gap-2">
              <input
                id="start-message-test-chat-id"
                type="text"
                placeholder="Chat ID"
                class="form-input flex-1 text-sm"
              />
              <button type="button" id="start-message-test-btn" class="btn-secondary text-xs px-4 py-2 whitespace-nowrap">
                Enviar teste
              </button>
            </div>
            <p class="text-xs text-zinc-500 mt-1">Envia a mensagem atual sem salvar</p>
            <div id="start-message-test-result" class="mt-2 text-xs hidden"></div>
          </div>

          <!-- Rodap√© -->
          <div class="flex flex-col gap-3 sm:flex-row sm:justify-end border-t border-zinc-700 pt-4">
            <button type="button" class="btn-secondary sm:flex-1" data-close-modal="start-message-modal">Cancelar</button>
            <button type="button" id="start-message-save-btn" class="btn-secondary sm:flex-1">Salvar</button>
            <button type="submit" id="start-message-save-close-btn" class="btn-primary sm:flex-1">Salvar & Fechar</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal: Gerenciar Downsells -->
    <div id="downsells-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="downsells-modal-title">
      <div class="modal-content" style="max-width: 1000px;">
        <header class="modal-header">
          <h2 id="downsells-modal-title" class="text-lg font-semibold">Downsells</h2>
          <button class="modal-close" type="button" data-close-modal="downsells-modal" aria-label="Fechar">‚úñÔ∏è</button>
        </header>
        
        <div class="space-y-4">
          <!-- Aviso sobre regra de neg√≥cio -->
          <div class="rounded-xl bg-blue-900/20 border border-blue-700/30 p-4">
            <div class="flex items-start gap-3">
              <span class="text-blue-400 text-xl">‚ÑπÔ∏è</span>
              <div class="flex-1">
                <p class="text-sm text-blue-200 font-medium mb-1">Regra de envio</p>
                <p class="text-xs text-blue-300">
                  Downsells s√≥ s√£o enviados se houver <strong>PIX gerado e n√£o pago</strong> no momento do disparo.
                  Ao pagar, <strong>todos os downsells pendentes s√£o cancelados</strong> automaticamente.
                </p>
              </div>
            </div>
          </div>

          <!-- Barra de a√ß√µes -->
          <div class="flex flex-col gap-3 sm:flex-row sm:items-center sm:justify-between">
            <div class="flex-1">
              <input
                id="downsells-search"
                type="text"
                placeholder="Buscar por t√≠tulo ou conte√∫do..."
                class="form-input text-sm w-full"
              />
            </div>
            <button id="new-downsell-btn" class="btn-primary text-sm px-4 py-2 whitespace-nowrap">
              ‚ûï Novo Downsell
            </button>
          </div>

          <!-- Lista/Tabela -->
          <div id="downsells-list-container">
            <!-- Loading state -->
            <div id="downsells-loading" class="hidden py-12 text-center">
              <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-accent"></div>
              <p class="text-sm text-zinc-400 mt-3">Carregando downsells...</p>
            </div>

            <!-- Empty state -->
            <div id="downsells-empty" class="hidden py-12 text-center">
              <p class="text-zinc-400 mb-3">Nenhum downsell configurado</p>
              <button class="btn-primary text-sm px-4 py-2" data-action="new-downsell">
                ‚ûï Criar primeiro downsell
              </button>
            </div>

            <!-- Error state -->
            <div id="downsells-error" class="hidden py-12 text-center">
              <p class="text-red-400 mb-3">Erro ao carregar downsells</p>
              <button class="btn-secondary text-sm px-4 py-2" data-action="retry-load-downsells">
                üîÑ Tentar novamente
              </button>
            </div>

            <!-- Table -->
            <div id="downsells-table-wrapper" class="hidden overflow-x-auto">
              <table class="min-w-full divide-y divide-surfaceMuted text-sm">
                <thead class="bg-surface">
                  <tr>
                    <th scope="col" class="table-head">T√≠tulo</th>
                    <th scope="col" class="table-head">Gatilhos</th>
                    <th scope="col" class="table-head">Delay</th>
                    <th scope="col" class="table-head">Ativo</th>
                    <th scope="col" class="table-head">Pr√©via</th>
                    <th scope="col" class="table-head">A√ß√µes</th>
                  </tr>
                </thead>
                <tbody id="downsells-table-body" class="divide-y divide-surfaceMuted">
                  <!-- Conte√∫do din√¢mico -->
                </tbody>
              </table>
            </div>
          </div>

          <!-- Footer -->
          <div class="flex justify-between items-center border-t border-zinc-700 pt-4">
            <p class="text-xs text-zinc-500">
              Total: <span id="downsells-count">0</span> downsell(s)
            </p>
            <button type="button" class="btn-secondary" data-close-modal="downsells-modal">Fechar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal: Criar/Editar Downsell -->
    <div id="downsell-form-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="downsell-form-modal-title">
      <div class="modal-content" style="max-width: 700px;">
        <header class="modal-header">
          <h2 id="downsell-form-modal-title" class="text-lg font-semibold">Novo Downsell</h2>
          <button class="modal-close" type="button" data-close-modal="downsell-form-modal" aria-label="Fechar">‚úñÔ∏è</button>
        </header>
        
        <form id="downsell-form" class="space-y-4">
          <!-- T√≠tulo -->
          <div class="form-field">
            <label for="downsell-title" class="form-label">T√≠tulo (opcional)</label>
            <input
              id="downsell-title"
              type="text"
              maxlength="120"
              placeholder="Ex: Downsell 20 minutos"
              class="form-input"
            />
            <p class="text-xs text-zinc-500 mt-1">
              <span id="downsell-title-count">0</span> / 120 caracteres
            </p>
          </div>

          <!-- Copy -->
          <div class="form-field">
            <label for="downsell-copy" class="form-label">
              Texto da mensagem <span class="text-rose-400">*</span>
            </label>
            <textarea
              id="downsell-copy"
              rows="6"
              maxlength="4096"
              required
              placeholder="Ainda est√° a√≠? Temos uma oferta especial para voc√™..."
              class="form-input font-mono text-sm resize-y"
              style="min-height: 150px;"
            ></textarea>
            <div class="flex items-center justify-between mt-1">
              <p class="text-xs text-yellow-500">
                ‚ö†Ô∏è MarkdownV2 ativo. Escape caracteres especiais: _ * [ ] ( ) ~ ` > # + - = | { } . !
              </p>
              <p class="text-xs text-zinc-500">
                <span id="downsell-copy-count">0</span> / 4096
              </p>
            </div>
            <p class="form-hint hidden text-rose-400" data-error-for="copy"></p>
          </div>

          <!-- M√≠dia (opcional) -->
          <div class="form-field">
            <label for="downsell-media-type" class="form-label">M√≠dia (opcional)</label>
            <select id="downsell-media-type" class="form-input">
              <option value="none">Nenhuma</option>
              <option value="photo">Foto</option>
              <option value="video">V√≠deo</option>
            </select>
          </div>

          <div id="downsell-media-fields" class="space-y-3 hidden">
            <div class="form-field">
              <label for="downsell-file-id" class="form-label">File ID do Telegram</label>
              <input
                id="downsell-file-id"
                type="text"
                placeholder="AgACAgEAAxkBAAI..."
                class="form-input"
              />
              <p class="text-xs text-zinc-500 mt-1">
                Use o file_id de uma m√≠dia j√° enviada no Telegram
              </p>
            </div>
            <div class="form-field">
              <label for="downsell-caption" class="form-label">Caption (MarkdownV2)</label>
              <textarea
                id="downsell-caption"
                rows="3"
                maxlength="1024"
                placeholder="Legenda da m√≠dia..."
                class="form-input font-mono text-sm"
              ></textarea>
            </div>
          </div>

          <!-- Gatilhos -->
          <div class="form-field">
            <label class="form-label">Gatilhos de disparo <span class="text-rose-400">*</span></label>
            <div class="space-y-2">
              <label class="inline-flex items-center gap-2 text-sm">
                <input id="downsell-after-start" type="checkbox" class="form-checkbox" />
                <span>Disparar ap√≥s /start</span>
              </label>
              <label class="inline-flex items-center gap-2 text-sm">
                <input id="downsell-after-pix" type="checkbox" class="form-checkbox" />
                <span>Disparar ap√≥s PIX gerado</span>
              </label>
            </div>
            <p class="form-hint hidden text-rose-400" data-error-for="triggers">
              Selecione pelo menos um gatilho
            </p>
          </div>

          <!-- Delay -->
          <div class="form-field">
            <label for="downsell-delay" class="form-label">
              Delay (minutos) <span class="text-rose-400">*</span>
            </label>
            <input
              id="downsell-delay"
              type="number"
              min="0"
              step="1"
              required
              value="20"
              class="form-input"
            />
            <p class="text-xs text-zinc-500 mt-1">
              Ser√° enviado em: <span id="downsell-delay-preview" class="font-medium text-accent">20 minutos</span>
            </p>
            <p class="form-hint hidden text-rose-400" data-error-for="delay"></p>
          </div>

          <!-- Ativo -->
          <div class="form-field">
            <label class="inline-flex items-center gap-2 text-sm">
              <input id="downsell-active" type="checkbox" class="form-checkbox" checked />
              <span class="font-medium">Ativo</span>
            </label>
            <p class="text-xs text-zinc-500 mt-1">Downsells inativos n√£o ser√£o agendados</p>
          </div>

          <!-- Aviso -->
          <div class="rounded-lg bg-zinc-800 border border-zinc-700 p-3">
            <p class="text-xs text-zinc-400">
              üí° O envio s√≥ ocorre se houver PIX gerado e n√£o pago na hora do disparo. 
              Se houver pagamento, cancelamos todas as pend√™ncias automaticamente.
            </p>
          </div>

          <!-- Footer -->
          <div class="flex flex-col gap-3 sm:flex-row sm:justify-end border-t border-zinc-700 pt-4">
            <button type="button" class="btn-secondary sm:flex-1" data-close-modal="downsell-form-modal">Cancelar</button>
            <button type="submit" id="downsell-save-btn" class="btn-primary sm:flex-1">Salvar</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal: Testar Downsell -->
    <div id="downsell-test-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="downsell-test-modal-title">
      <div class="modal-content" style="max-width: 500px;">
        <header class="modal-header">
          <h2 id="downsell-test-modal-title" class="text-lg font-semibold">Testar Downsell</h2>
          <button class="modal-close" type="button" data-close-modal="downsell-test-modal" aria-label="Fechar">‚úñÔ∏è</button>
        </header>
        
        <form id="downsell-test-form" class="space-y-4">
          <input type="hidden" id="test-downsell-id" />

          <!-- Telegram ID -->
          <div class="form-field">
            <label for="test-telegram-id" class="form-label">
              Telegram ID <span class="text-rose-400">*</span>
            </label>
            <input
              id="test-telegram-id"
              type="text"
              required
              placeholder="123456789"
              class="form-input"
            />
            <p class="text-xs text-zinc-500 mt-1">ID do usu√°rio que receber√° o teste</p>
          </div>

          <!-- Gatilho -->
          <div class="form-field">
            <label class="form-label">Simular gatilho <span class="text-rose-400">*</span></label>
            <div class="space-y-2">
              <label class="inline-flex items-center gap-2 text-sm">
                <input type="radio" name="test-trigger" value="start" class="form-radio" checked />
                <span>/start</span>
              </label>
              <label class="inline-flex items-center gap-2 text-sm">
                <input type="radio" name="test-trigger" value="pix" class="form-radio" />
                <span>PIX</span>
              </label>
            </div>
          </div>

          <!-- Transaction ID (condicional) -->
          <div id="test-transaction-field" class="form-field hidden">
            <label for="test-transaction-id" class="form-label">
              Transaction ID <span class="text-rose-400">*</span>
            </label>
            <input
              id="test-transaction-id"
              type="text"
              placeholder="tx-abc123"
              class="form-input"
            />
            <p class="text-xs text-zinc-500 mt-1">ID da transa√ß√£o PIX a simular</p>
          </div>

          <!-- Quando enviar -->
          <div class="form-field">
            <label for="test-respect-delay" class="form-label">Quando enviar</label>
            <select id="test-respect-delay" class="form-input">
              <option value="false">Agora (ignora delay)</option>
              <option value="true">Respeitar delay configurado</option>
            </select>
          </div>

          <!-- Aviso -->
          <div class="rounded-lg bg-yellow-900/20 border border-yellow-700/30 p-3">
            <p class="text-xs text-yellow-300">
              ‚ö†Ô∏è O backend vai checar se h√° PIX n√£o pago antes de enviar. 
              Se n√£o houver, o teste ser√° ignorado com status "skipped".
            </p>
          </div>

          <!-- Footer -->
          <div class="flex flex-col gap-3 sm:flex-row sm:justify-end border-t border-zinc-700 pt-4">
            <button type="button" class="btn-secondary sm:flex-1" data-close-modal="downsell-test-modal">Cancelar</button>
            <button type="submit" id="downsell-test-submit-btn" class="btn-primary sm:flex-1">Executar Teste</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Modal: Confirmar Exclus√£o de Downsell -->
    <div id="downsell-delete-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="downsell-delete-modal-title">
      <div class="modal-content">
        <header class="modal-header">
          <h2 id="downsell-delete-modal-title" class="text-lg font-semibold">Confirmar Exclus√£o</h2>
          <button class="modal-close" type="button" data-close-modal="downsell-delete-modal" aria-label="Fechar">‚úñÔ∏è</button>
        </header>
        <div class="space-y-4">
          <p class="text-sm text-zinc-300">
            Voc√™ est√° prestes a excluir o downsell <strong id="delete-downsell-name"></strong>.
          </p>
          <p class="text-sm text-zinc-400">
            Esta a√ß√£o n√£o pode ser desfeita. Downsells pendentes na fila ser√£o mantidos at√© serem processados ou cancelados.
          </p>
          <div class="flex flex-col gap-3 sm:flex-row sm:justify-end">
            <button type="button" class="btn-secondary sm:flex-1" data-close-modal="downsell-delete-modal">Cancelar</button>
            <button type="button" id="confirm-downsell-delete-btn" class="btn-primary sm:flex-1 bg-red-600 hover:bg-red-700">Excluir</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal: Pr√©via do Downsell -->
    <div id="downsell-preview-modal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="downsell-preview-modal-title">
      <div class="modal-content" style="max-width: 600px;">
        <header class="modal-header">
          <h2 id="downsell-preview-modal-title" class="text-lg font-semibold">Pr√©via do Downsell</h2>
          <button class="modal-close" type="button" data-close-modal="downsell-preview-modal" aria-label="Fechar">‚úñÔ∏è</button>
        </header>
        <div class="space-y-4">
          <div class="rounded-xl bg-surface border border-surfaceMuted p-4">
            <pre id="downsell-preview-content" class="text-sm text-zinc-300 whitespace-pre-wrap font-mono"></pre>
          </div>
          <div class="flex justify-end">
            <button type="button" class="btn-secondary" data-close-modal="downsell-preview-modal">Fechar</button>
          </div>
        </div>
      </div>
    </div>

    <script src="admin.js"></script>
  </body>
</html>
